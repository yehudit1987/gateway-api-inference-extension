/*
Copyright 2025 The Kubernetes Authors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

package server

import (
	"fmt"

	"github.com/spf13/pflag"

	"sigs.k8s.io/gateway-api-inference-extension/pkg/bbr/config"
	"sigs.k8s.io/gateway-api-inference-extension/pkg/common/observability/logging"
)

const (
	DefaultGrpcPort       = 9004
	DefaultGrpcHealthPort = 9005
)

// Options contains the command-line configuration for the BBR server.
type Options struct {
	//
	// ext_proc configuration.
	//
	GRPCPort  int  // gRPC port for communicating with Envoy proxy.
	Streaming bool // Enables streaming support for Envoy full-duplex streaming mode.
	//
	// Diagnostics.
	//
	logging.Options          // Embedded logging configuration.
	MetricsPort         int  // The metrics port exposed by BBR.
	GRPCHealthPort      int  // The port for gRPC liveness and readiness probes.
	EnablePprof         bool // Enables pprof handlers.
	SecureServing       bool // Enables secure serving.
	MetricsEndpointAuth bool // Enables authentication and authorization of the metrics endpoint.
	//
	// Plugins.
	//
	PluginSpecs config.BBRPluginSpecs // Repeatable --plugin <type>:<name>[:<json>] flag values.
}

// NewOptions returns a new Options struct initialized with default values.
func NewOptions() *Options {
	return &Options{
		GRPCPort:            DefaultGrpcPort,
		GRPCHealthPort:      DefaultGrpcHealthPort,
		Options:             *logging.NewOptions(),
		MetricsPort:         9090,
		EnablePprof:         true,
		SecureServing:       true,
		MetricsEndpointAuth: true,
	}
}

// AddFlags binds the Options fields to command-line flags on the given FlagSet.
func (opts *Options) AddFlags(fs *pflag.FlagSet) {
	if fs == nil {
		fs = pflag.CommandLine
	}

	fs.IntVar(&opts.GRPCPort, "grpc-port", opts.GRPCPort,
		"The gRPC port used for communicating with Envoy proxy.")
	fs.IntVar(&opts.GRPCHealthPort, "grpc-health-port", opts.GRPCHealthPort,
		"The port used for gRPC liveness and readiness probes.")
	fs.IntVar(&opts.MetricsPort, "metrics-port", opts.MetricsPort,
		"The metrics port exposed by BBR.")
	fs.BoolVar(&opts.MetricsEndpointAuth, "metrics-endpoint-auth", opts.MetricsEndpointAuth,
		"Enables authentication and authorization of the metrics endpoint.")
	fs.BoolVar(&opts.Streaming, "streaming", opts.Streaming,
		"Enables streaming support for Envoy full-duplex streaming mode.")
	fs.BoolVar(&opts.SecureServing, "secure-serving", opts.SecureServing,
		"Enables secure serving.")
	fs.BoolVar(&opts.EnablePprof, "enable-pprof", opts.EnablePprof,
		"Enables pprof handlers. Defaults to true. Set to false to disable pprof handlers.")

	fs.Var(&opts.PluginSpecs, "plugin", `Repeatable. --plugin <type>:<name>[:<json>]`)

	// Add logging flags.
	opts.Options.AddFlags(fs)
}

// Complete performs post-processing of parsed command-line arguments.
func (opts *Options) Complete() error {
	// Complete logging options.
	return opts.Options.Complete()
}

// Validate checks the Options for invalid or conflicting values.
func (opts *Options) Validate() error {
	// Validate port ranges.
	for _, pc := range []struct {
		name string
		port int
	}{
		{"grpc-port", opts.GRPCPort},
		{"grpc-health-port", opts.GRPCHealthPort},
		{"metrics-port", opts.MetricsPort},
	} {
		if pc.port < 1 || pc.port > 65535 {
			return fmt.Errorf("invalid value %d for flag %q: must be between 1 and 65535", pc.port, pc.name)
		}
	}

	// Validate that the three server ports do not collide.
	ports := map[int]string{
		opts.GRPCPort:       "grpc-port",
		opts.GRPCHealthPort: "grpc-health-port",
		opts.MetricsPort:    "metrics-port",
	}
	if len(ports) < 3 {
		return fmt.Errorf("port conflict: grpc-port (%d), grpc-health-port (%d), and metrics-port (%d) must all be different",
			opts.GRPCPort, opts.GRPCHealthPort, opts.MetricsPort)
	}

	// Validate logging options.
	if err := opts.Options.Validate(); err != nil {
		return err
	}

	return nil
}
